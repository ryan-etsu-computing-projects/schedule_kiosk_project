{% extends 'base.html' %}

{% block title %}Course Schedule Kiosk{% endblock %}

{% block content %}
<div class="kiosk-container">
    <div class="header">
        <h1><i class="fas fa-calendar-alt"></i> Course Schedule</h1>
        <div class="current-time" id="current-time"></div>
    </div>
    
    <div class="slide-container">
        <!-- Today's Schedule Slide -->
        <div class="slide active" id="slide-today">
            <div class="today-schedule">
                <h2 id="today-title">Today's Schedule</h2>
                <div class="loading" id="today-loading">
                    <div class="spinner"></div>
                    Loading today's schedule...
                </div>
                <div class="time-grid" id="today-grid" style="display: none;">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Monday-Wednesday Schedule Slide -->
        <div class="slide" id="slide-mw">
            <div class="weekly-schedule">
                <h2>Monday - Wednesday Schedule</h2>
                <div class="loading" id="mw-loading">
                    <div class="spinner"></div>
                    Loading weekly schedule...
                </div>
                <div class="weekly-grid three-day" id="mw-grid" style="display: none;">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Thursday-Friday Schedule Slide -->
        <div class="slide" id="slide-tf">
            <div class="weekly-schedule">
                <h2>Thursday - Friday Schedule</h2>
                <div class="loading" id="tf-loading">
                    <div class="spinner"></div>
                    Loading weekly schedule...
                </div>
                <div class="weekly-grid two-day" id="tf-grid" style="display: none;">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <div class="slide-indicators">
        <div class="indicator active" data-slide="0"></div>
        <div class="indicator" data-slide="1"></div>
        <div class="indicator" data-slide="2"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class ScheduleKiosk {
    constructor() {
        this.currentSlide = 0;
        this.slides = ['today', 'mw', 'tf'];
        this.slideInterval = 10000; // 10 seconds per slide
        this.refreshInterval = 60000; // Refresh data every minute
        
        this.init();
    }

    init() {
        this.updateClock();
        this.loadAllSchedules();
        this.startSlideRotation();
        this.startClockUpdate();
        this.startDataRefresh();
        this.setupEventListeners();
    }

    updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
        const dateString = now.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
    }

    async loadAllSchedules() {
        await Promise.all([
            this.loadTodaySchedule(),
            this.loadWeeklySchedule('mw'),
            this.loadWeeklySchedule('tf')
        ]);
    }

    async loadTodaySchedule() {
        try {
            const response = await fetch('/api/today/');
            const data = await response.json();
            
            document.getElementById('today-title').textContent = `${data.day_name}'s Schedule`;
            
            const grid = document.getElementById('today-grid');
            grid.innerHTML = '';
            
            // Add current time indicator
            this.addCurrentTimeIndicator(grid, data.schedule);
            
            data.schedule.forEach(slot => {
                // Time slot
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-slot';
                timeDiv.textContent = slot.time;
                grid.appendChild(timeDiv);
                
                // Session slot
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-slot';
                
                slot.sessions.forEach(session => {
                    const sessionCard = document.createElement('div');
                    sessionCard.className = 'session-card';
                    sessionCard.innerHTML = `
                        <div class="course-code">${session.course_code}</div>
                        <div class="title">${session.title}</div>
                        <div class="instructor"><i class="fas fa-user"></i> ${session.instructor}</div>
                        <div class="location"><i class="fas fa-map-marker-alt"></i> ${session.location}</div>
                    `;
                    sessionDiv.appendChild(sessionCard);
                });
                
                grid.appendChild(sessionDiv);
            });
            
            document.getElementById('today-loading').style.display = 'none';
            grid.style.display = 'grid';
            
        } catch (error) {
            console.error('Error loading today schedule:', error);
        }
    }

    async loadWeeklySchedule(type) {
        try {
            const response = await fetch(`/api/weekly/?type=${type}`);
            const data = await response.json();
            
            const grid = document.getElementById(`${type}-grid`);
            grid.innerHTML = '';
            
            // Add day headers
            const emptyHeader = document.createElement('div');
            grid.appendChild(emptyHeader);
            
            data.day_names.forEach(dayName => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = dayName;
                grid.appendChild(dayHeader);
            });
            
            // Add schedule rows
            data.schedule.forEach(slot => {
                // Time slot
                const timeDiv = document.createElement('div');
                timeDiv.className = 'weekly-time-slot';
                timeDiv.textContent = slot.time;
                grid.appendChild(timeDiv);
                
                // Day columns
                data.days.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weekly-session-slot';
                    
                    const dayData = slot.days[day];
                    if (dayData && dayData.sessions.length > 0) {
                        dayData.sessions.forEach(session => {
                            const sessionCard = document.createElement('div');
                            sessionCard.className = 'weekly-session-card';
                            sessionCard.innerHTML = `
                                <div class="course-code">${session.course_code}</div>
                                <div class="location">${session.location}</div>
                            `;
                            dayDiv.appendChild(sessionCard);
                        });
                    }
                    
                    grid.appendChild(dayDiv);
                });
            });
            
            document.getElementById(`${type}-loading`).style.display = 'none';
            grid.style.display = 'grid';
            
        } catch (error) {
            console.error(`Error loading ${type} schedule:`, error);
        }
    }

    addCurrentTimeIndicator(grid, schedule) {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        
        // Find the appropriate position for the current time indicator
        let position = 0;
        for (let i = 0; i < schedule.length; i++) {
            const [hours, minutes] = schedule[i].time_24.split(':').map(Number);
            const slotTime = hours * 60 + minutes;
            
            if (currentTime >= slotTime) {
                position = i;
            } else {
                break;
            }
        }
        
        // Create and position the indicator
        const indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        indicator.style.top = `${position * 40 + 20}px`; // Adjust based on row height
        grid.appendChild(indicator);
    }

    startSlideRotation() {
        setInterval(() => {
            this.nextSlide();
        }, this.slideInterval);
    }

    nextSlide() {
        // Hide current slide
        document.getElementById(`slide-${this.slides[this.currentSlide]}`).classList.remove('active');
        document.querySelector(`.indicator[data-slide="${this.currentSlide}"]`).classList.remove('active');
        
        // Move to next slide
        this.currentSlide = (this.currentSlide + 1) % this.slides.length;
        
        // Show next slide
        document.getElementById(`slide-${this.slides[this.currentSlide]}`).classList.add('active');
        document.querySelector(`.indicator[data-slide="${this.currentSlide}"]`).classList.add('active');
    }

    startClockUpdate() {
        setInterval(() => {
            this.updateClock();
        }, 1000);
    }

    startDataRefresh() {
        setInterval(() => {
            this.loadAllSchedules();
        }, this.refreshInterval);
    }

    setupEventListeners() {
        // Allow manual slide navigation (for testing)
        document.querySelectorAll('.indicator').forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
                if (index !== this.currentSlide) {
                    document.getElementById(`slide-${this.slides[this.currentSlide]}`).classList.remove('active');
                    document.querySelector(`.indicator[data-slide="${this.currentSlide}"]`).classList.remove('active');
                    
                    this.currentSlide = index;
                    
                    document.getElementById(`slide-${this.slides[this.currentSlide]}`).classList.add('active');
                    document.querySelector(`.indicator[data-slide="${this.currentSlide}"]`).classList.add('active');
                }
            });
        });
    }
}

// Initialize kiosk when page loads
document.addEventListener('DOMContentLoaded', () => {
    new ScheduleKiosk();
});
</script>
{% endblock %}
